{% extends 'storefront/base.html' %}
{% load static %}

{% block title %}AuroraMart Storefront{% endblock %}

{% block header_search_bar %}
<form action="" method="GET" class="search-form">
    <input type="search" name="query" class="search-bar" placeholder="Search products..." value="{{ request.GET.query }}">
    {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %} 

    <input type="hidden" name="category" value="{{ active_category|default:'All' }}">
</form>
{% endblock %}

{% block content %}
    <div class="banner">
        <p>Personalised for you.</p>
        <h2>Based on your interests, we recommend {{ recommended_category|default:'Electronics' }}</h2>
    </div>

    <div class="nav-tabs">
        <a href="{% url 'storefront_home' %}?category=All{% if query %}&query={{ query|urlencode }}{% endif %}{% if sort %}&sort={{ sort|urlencode }}{% endif %}" 
           class="tab {% if active_category == 'All' %}active{% endif %}">
           All
        </a>
        {% for category in categories %}
        <a href="{% url 'storefront_home' %}?category={{ category|urlencode }}{% if query %}&query={{ query|urlencode }}{% endif %}{% if sort %}&sort={{ sort|urlencode }}{% endif %}" 
           class="tab {% if category == active_category %}active{% endif %}
           {% if category == recommended_category %}recommended{% endif %}">
            {{ category }}
        </a>
        {% endfor %}

        <form action="{% url 'storefront_home' %}" method="GET" class="sort-bar">
            <label for="sort-options">Sort by:</label>
            <select id="sort-options" name="sort" onchange="this.form.submit()"> 
                <option value="name-asc" {% if sort == 'name-asc' %}selected{% endif %}>Name (A–Z)</option>
                <option value="name-desc" {% if sort == 'name-desc' %}selected{% endif %}>Name (Z–A)</option>
                <option value="price-asc" {% if sort == 'price-asc' %}selected{% endif %}>Price (Low → High)</option>
                <option value="price-desc" {% if sort == 'price-desc' %}selected{% endif %}>Price (High → Low)</option>
                <option value="rating-desc" {% if sort == 'rating-desc' %}selected{% endif %}>Rating (High → Low)</option>
                <option value="rating-asc" {% if sort == 'rating-asc' %}selected{% endif %}>Rating (Low → High)</option>
            </select>
            {% if query %}<input type="hidden" name="query" value="{{ query}}">{% endif %}
            <input type="hidden" name="category" value="{{ active_category|default:'All' }}">
        </form>
    </div>
    

    <div class="product-grid">
        {% for product in products %}
            <div class="product-card">
                <a href="#modal-{{ product.sku_code }}" class="product-link">
                    <div class="product-image">
                        <img src="https://nus.edu.sg/images/default-source/identity-images/NUS_logo_full-horizontal.jpg" 
                             alt="{{ product.product_name }}">
                    </div>
                    <div class="product-title">{{ product.product_name }}</div>
                    <div class="product-meta">
                        <div class="rating">★ {{ product.product_rating }}</div>
                        <div class="stock">{{ product.quantity_on_hand }} left</div>
                    </div>
                    <div class="price">${{ product.unit_price }}</div>
                </a>
    
                <div class="buttons">
                    <form action="{% url 'buy_now' product.sku_code %}" method="GET" class="buy-now-form">
                        <input type="hidden" name="quantity" id="buy-now-quantity-{{ product.sku_code }}">
                        <button type="submit" class="buy-now" onclick="document.getElementById('buy-now-quantity-{{ product.sku_code }}').value = document.getElementById('quantity-{{ product.sku_code }}').value;"><i class="fas fa-bolt"></i> Buy Now</button>
                    </form>
                    <form action="{% url 'storefront_home' %}" method="POST" class="add-to-cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="sku_code" value="{{ product.sku_code }}">
                        <button type="submit" class="add-cart"><i class="fas fa-cart-plus"></i> Add</button>
                        <input type="number" name="quantity" value="1" min="1" class="quantity-input-detail" id="quantity-{{ product.sku_code }}">
                    </form>
                </div>
            </div>

            <div id="modal-{{ product.sku_code }}" class="css-modal">
                <div class="css-modal-content">
                    <a href="" class="css-close">&times;</a>
    
                    <img src="https://nus.edu.sg/images/default-source/identity-images/NUS_logo_full-horizontal.jpg" 
                         alt="{{ product.product_name }}" class="modal-img">
                    <h2>{{ product.product_name }}</h2>
                    <p class="price">${{ product.unit_price }}</p>
                    <p>{{ product.product_description }}</p>
                    <p>★ {{ product.product_rating }} | {{ product.quantity_on_hand }} left</p>
    
                    <form action="{% url 'storefront_home' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="sku_code" value="{{ product.sku_code }}">
                        <button type="submit" class="add-cart"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                        <input type="number" name="quantity" value="1" min="1" class="quantity-input-detail">
                    </form>
                    <br/>
                    <a href="{% url 'start_chat' product.sku_code %}" class="buy-now"><i class="fas fa-comments"></i> Chat with Seller</a>
    
                    <a href="{% url 'product_detail' product.sku_code %}" class="buy-now"><i class="fas fa-search-plus"></i> View Full Details</a>
                </div>
            </div>
        {% empty %}
            <p>No products found.</p>
        {% endfor %}
    </div>    
{% endblock %}