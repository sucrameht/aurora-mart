{% extends 'auroraadmin/base.html' %}
{% load static %}
{% block title %}Bulk Status Update{% endblock %}
{% block extra_css %}
<style>
    .container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .section {
        margin-bottom: 40px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    
    .section h3 {
        margin-top: 0;
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }
    
    .transactions-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transactions-table th,
    .transactions-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .transactions-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
    }
    
    .transactions-table tr:hover {
        background-color: #ecf0f1;
    }
    
    .transactions-table input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .update-form {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background-color: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #2980b9;
    }
    
    .btn-primary:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
    }
    
    .select-all-btn {
        padding: 8px 16px;
        margin-bottom: 15px;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }
    
    .select-all-btn:hover {
        background-color: #229954;
    }
    
    .empty-message {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-style: italic;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-payment {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-warehouse {
        background-color: #cfe2ff;
        color: #084298;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container">
    <h2>Bulk Transaction Status Update</h2>
    <p>Select one or more transactions below and choose an action to update their status.</p>
    
    <!-- Update Form -->
    <div class="update-form">
        <form method="post" id="bulkUpdateForm">
            {% csrf_token %}
            <div class="form-group">
                {{ form.action.label_tag }}
                {{ form.action }}
                {% if form.action.errors %}
                    <div style="color: red; margin-top: 5px;">{{ form.action.errors }}</div>
                {% endif %}
            </div>
            
            {{ form.transaction_ids }}
            
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                Update Selected Transactions
            </button>
            <span id="selectedCount" style="margin-left: 15px; color: #7f8c8d;">No transactions selected</span>
        </form>
    </div>
    
    <!-- Payment Made Section -->
    <div class="section">
        <h3>Payment Made ({{ payment_made.count }})</h3>
        {% if payment_made %}
            <button type="button" class="select-all-btn" onclick="toggleSelectAll('payment')">Select All</button>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllPayment" onchange="toggleGroupSelect('payment', this.checked)">
                        </th>
                        <th>Transaction ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total Spent</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in payment_made %}
                    <tr>
                        <td>
                            <input type="checkbox" class="transaction-checkbox payment-checkbox" 
                                   value="{{ transaction.id }}" onchange="updateSelection()">
                        </td>
                        <td>#{{ transaction.id }}</td>
                        <td>{{ transaction.user.username }}</td>
                        <td>{{ transaction.transaction_datetime|date:"Y-m-d H:i" }}</td>
                        <td>{{ transaction.viewcal_num_of_products }}</td>
                        <td>S${{ transaction.viewcal_total_spent|floatformat:2 }}</td>
                        <td><span class="status-badge status-payment">{{ transaction.status }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-message">No transactions with "Payment Made" status.</div>
        {% endif %}
    </div>
    
    <!-- Delivered to Warehouse Section -->
    <div class="section">
        <h3>Delivered to Warehouse ({{ delivered_warehouse.count }})</h3>
        {% if delivered_warehouse %}
            <button type="button" class="select-all-btn" onclick="toggleSelectAll('warehouse')">Select All</button>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllWarehouse" onchange="toggleGroupSelect('warehouse', this.checked)">
                        </th>
                        <th>Transaction ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total Spent</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in delivered_warehouse %}
                    <tr>
                        <td>
                            <input type="checkbox" class="transaction-checkbox warehouse-checkbox" 
                                   value="{{ transaction.id }}" onchange="updateSelection()">
                        </td>
                        <td>#{{ transaction.id }}</td>
                        <td>{{ transaction.user.username }}</td>
                        <td>{{ transaction.transaction_datetime|date:"Y-m-d H:i" }}</td>
                        <td>{{ transaction.viewcal_num_of_products }}</td>
                        <td>S${{ transaction.viewcal_total_spent|floatformat:2 }}</td>
                        <td><span class="status-badge status-warehouse">{{ transaction.status }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-message">No transactions with "Delivered to Warehouse" status.</div>
        {% endif %}
    </div>
</div>

<script>
function updateSelection() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const count = checkboxes.length;
    const submitBtn = document.getElementById('submitBtn');
    const selectedCount = document.getElementById('selectedCount');
    const transactionIdsInput = document.getElementById('id_transaction_ids');
    
    if (count > 0) {
        submitBtn.disabled = false;
        selectedCount.textContent = `${count} transaction(s) selected`;
        selectedCount.style.color = '#27ae60';
        
        // Update hidden input with selected IDs
        const ids = Array.from(checkboxes).map(cb => cb.value);
        transactionIdsInput.value = ids.join(',');
    } else {
        submitBtn.disabled = true;
        selectedCount.textContent = 'No transactions selected';
        selectedCount.style.color = '#7f8c8d';
        transactionIdsInput.value = '';
    }
}

function toggleGroupSelect(group, checked) {
    const checkboxes = document.querySelectorAll(`.${group}-checkbox`);
    checkboxes.forEach(cb => cb.checked = checked);
    updateSelection();
}

function toggleSelectAll(group) {
    const selectAllCheckbox = document.getElementById(`selectAll${group.charAt(0).toUpperCase() + group.slice(1)}`);
    const isCurrentlyChecked = selectAllCheckbox.checked;
    selectAllCheckbox.checked = !isCurrentlyChecked;
    toggleGroupSelect(group, !isCurrentlyChecked);
}

// Form validation
document.getElementById('bulkUpdateForm').addEventListener('submit', function(e) {
    const action = document.getElementById('id_action').value;
    const transactionIds = document.getElementById('id_transaction_ids').value;
    
    if (!action) {
        e.preventDefault();
        alert('Please select an action.');
        return false;
    }
    
    if (!transactionIds) {
        e.preventDefault();
        alert('Please select at least one transaction.');
        return false;
    }
    
    if (!confirm(`Are you sure you want to update ${document.querySelectorAll('.transaction-checkbox:checked').length} transaction(s)?`)) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
