{% extends 'auroraadmin/base.html' %}
{% block title %} {{ page_title }} {% endblock %}

{% block main_content %}

<style>
    /* --- Styles for Voucher Assignment Page --- */
    .assign-container {
        padding: 20px;
        background-color: #f0f8ff;
        max-width: 800px; /* Constrain width for a form */
        margin: 0 auto; /* Center it */
    }
    
    /* Back link */
    .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #007ca5;
        font-weight: 600;
        text-decoration: none;
    }
    .back-link:hover {
        text-decoration: underline;
    }
    
    /* Form Container */
    .assign-form-container {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .form-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    .form-subtitle {
        font-size: 1rem;
        color: #555;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }
    
    /* Checkbox list styles */
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        font-weight: 600;
        font-size: 1.1rem;
        color: #007ca5;
        display: block;
        margin-bottom: 15px;
    }
    .checkbox-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 columns */
        gap: 12px;
    }
    .checkbox-list li {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
    .checkbox-list label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        font-size: 0.95rem;
        color: #333;
        cursor: pointer;
    }
    .checkbox-list input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #007ca5;
    }
    
    /* No vouchers message */
    .no-vouchers-message {
        font-size: 1rem;
        color: #777;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 6px;
        text-align: center;
    }

    /* Submit Button */
    .btn-submit {
        padding: 10px 20px;
        font-size: 1rem;
        background-color: #007ca5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .btn-submit:hover {
        background-color: #005f80;
    }

    /* Current Voucher Table*/
    .current-vouchers-container {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .current-vouchers-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th, .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
    }
    .data-table th {
        background-color: #f9f9f9;
        font-size: 0.75rem;
        font-weight: 600;
        color: #007ca5;
        text-transform: uppercase;
    }
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    .data-table .discount-type {
        text-transform: capitalize;
    }
    .data-table .text-right {
        text-align: right;
    }

</style>

<div class="assign-container">
    
    <!-- Link to go back to the customer list -->
    <a href="{% url 'auroraadmin:customers_list' %}" class="back-link">
        &larr; Back to customer list
    </a>

    <div class="assign-form-container">
        <h1 class="form-title">{{ page_title }}</h1>
        <p class="form-subtitle">
            User ID: {{ customer.id }}
        </p>
        
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <!-- This renders the 'vouchers_to_add' field -->
                {{ form.vouchers_to_add.label_tag }}
                
                <!-- Check if there are any vouchers to show -->
                {% if form.vouchers_to_add.field.queryset.exists %}
                    <ul class="checkbox-list">

                        {% for checkbox in form.vouchers_to_add %}
                        <li>
                            <label for="{{ checkbox.id_for_label }}">
                                {{ checkbox.tag }}
                                {{ checkbox.choice_label }}
                            </label>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %} <!--User has all active vouchers-->
                    <p class="no-vouchers-message">
                        This user already has all available active vouchers.
                    </p>
                {% endif %}
                
                {{ form.vouchers_to_add.errors }}
            </div>
            
            <!-- Only show the button if there are vouchers to add -->
            {% if form.vouchers_to_add.field.queryset.exists %}
                <button type="submit" class="btn-submit">Assign Selected Vouchers</button>
            {% endif %}
            
        </form>
    </div>

    <div class="current-vouchers-container">
        <h2 class="current-vouchers-title">Current Vouchers ({{ current_vouchers.count }})</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Voucher Code</th>
                    <th class="text-right">Discount</th>
                    <th>Expiry Date</th>
                </tr>
            </thead>
            <tbody>
                {% for voucher in current_vouchers %}
                <tr>
                    <td>{{ voucher.code }}</td>
                    <td class="text-right">
                        {% if voucher.discount_type == 'percent' %}
                            {{ voucher.discount_value|floatformat:0 }}%
                        {% else %}
                            ${{ voucher.discount_value|floatformat:2 }}
                        {% endif %}
                    </td>
                    <td>{{ voucher.expiry_date|date:"d M Y"|default:"No Expiry" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align:center; padding: 20px;">
                        This user has no vouchers.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock main_content %}